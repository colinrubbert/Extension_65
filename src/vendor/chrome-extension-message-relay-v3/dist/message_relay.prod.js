/* Version 3.0.11 chrome-extension-message-relay (https://github.com/ecaroth/chrome-extension-message-relay), Authored by Evan Carothers */

(e=>{const n=function(n,t,i,s){s||(s="*");const o=i||!1,r=Object.freeze({service_worker:"service_worker",content:"content",page:"page",iframe:"iframe",iframe_shim:"iframe_shim",test:"test"}),a=Object.freeze({service_worker:4,content:3,page:2,iframe_shim:1,iframe:0,test:-1}),l=t;let c={},m=null,f=n,d=null,u=null,p={},g=[],h={},_=!1;const y="_CSTATE",$=Object.freeze({ready:"ready",initEnv:"initEnv",initialized:"initalized"}),v={},b="***";function I(e,n,t=null,i=!1,s=null){"string"==typeof e&&(e=[e]),t&&!Array.isArray(t)&&(t=[t]),e.forEach((e=>{let o=O(e);o.type in p||(p[o.type]=[]),p[o.type].push({fn:n,ns:o.namespace,limitFromLevels:t,componentFilter:s,isOnce:i})}))}function w(e,n=null){e&&("string"==typeof e&&(e=[e]),e.forEach((e=>{let n=O(e);n.type in p&&(n.namespace?M(n.type,n.namespace):delete p[n.type])})))}function E(e,n=null,t=null){let i=e;return n&&(i+="."+n),t&&(i+=`[${t}]`),i}function O(e){let n=null,t=null,i=null;const s=(e=e.split("@@@")[0]).match(/^([\w:_-]+)\.?([\w:_-]+)?(\[(.+)])?$/);return s[2]?(t=s[2],n=s[1]):n=s[1],s[4]&&(i=s[4]),{type:n,namespace:t,component:i}}function M(e,n){e in p&&(p[e]=p[e].filter((e=>e.ns!==n)),p[e].length||delete p[e])}function S(e,n,t,i,s){let o="msgId"in(s=A(s))?s.msgId:function(e,n){return`${e}:${n}@@@${J()}`}(n,e);s.msgId=o;let r={msgType:e,msgFrom:l,sourceLevel:t,msgDestination:n,msgUp:i,relayNamespace:f,msgData:s,msgId:o,msgTabId:null};const a=k(n);return a.tabId&&(r.msgDestination=a.level,r.msgTabId=a.tabId),r}function C(e,n,t,i=null){if(t=A(t),"string"==typeof n&&(n=[n]),i){const n=O(e);e=E(n.type,n.namespace,i)}n.forEach((n=>{if(!function(e){return!!e&&k(e).level in r}(n))return R(`NOTICE - invalid level specified as destination (${n})`);const i=k(n).level;a[i]<a[l]?N(e,n,t):function(e,n,t){const i=S(e,n,l,!0,t);R(`Send msg UP from ${l} to ${n} : ${e} - ${JSON.stringify(t)}`),T(i)}(e,n,t)}))}function N(e,n,t={}){const i=S(e,n,l,!1,t);R(`Send msg DOWN from ${l} to ${n} : ${e} - ${JSON.stringify(t)}`),T(i)}function T(n){!function(n,t){if(n===r.content&&t.msgDestination===r.service_worker||n===r.service_worker);else if(n===r.iframe||t.msgDestination!==r.iframe&&n===r.iframe_shim)e.parent.postMessage(t,s);else if(n!==r.page&&n!==r.content||![r.iframe,r.iframe_shim].includes(t.msgDestination))if(t.msgDestination===r.iframe&&n===r.iframe_shim)for(let n=0;n<e.frames.length;n++)e.frames[n].postMessage(t,"*");else e.postMessage(t,"*");else{const e=document.getElementsByTagName("iframe"),{component:n}=O(t.msgType);for(let i=0;i<e.length;i++){if(n&&!n.startsWith(b)&&e[i].getAttribute(z(n))!==$.ready)continue;let s="*";(l!==r.content||(s="chrome-extension://"+chrome.runtime.id,e[i].src.startsWith(s)))&&e[i].contentWindow.postMessage(t,s)}}}(l,n)}function D(e,n){const{msgData:t,msgFrom:i,sourceLevel:s,msgUp:o,msgDestination:m,msgType:f,msgId:_}=e;n&&(d=n),u=O(f);const v=`${_}:${m}`;if(i===l||v in c)return!1;m===l?(R(`Msg (${f}) received from ${i} to ${m} - ${JSON.stringify(t)}`),c[v]=0,function(e,n,t){delete n.msgId,delete n.msg_id;const{component:i,namespace:s,type:o}=O(e);if(i&&[r.content,r.page,r.iframe_shim].includes(l)){const e=d,n=Array.from(document.getElementsByTagName("iframe")).find((n=>n.contentWindow===e));if(s===y){if(o===$.ready){R(`Component ${i} is ready`);const e=z(i);n.setAttribute(e,$.ready);let t=function(e,n){return E(e,y,n)}($.initEnv,i);return N(t,r.iframe,h)}if(o===$.initialized){const e=L(i);g.forEach((t=>{t.name_filter&&0!==e.localeCompare(t.name_filter)||t.fn(e,n,d)}))}}}if(!(o in p))return;const a=p[o];for(let e=a.length-1;e>=0;e--){const s=a[e],o=s.limitFromLevels;if(!o||o.includes(t)){if(i&&[r.page,r.content,r.iframe_shim].includes(l)){const e=s.componentFilter;if(e!==b){const n=e||"";if(!n.startsWith(b)&&i!==e)return;if(n.startsWith(b)){if(L(i)!==e.replace(b,""))return}}}s.fn.call(s,n),s.isOnce&&a.splice(e,1)}}}(f,t,s)):(e.msgFrom=l,o&&a[l]>a[i]?(T(e),R(`Msg (${f}) relaying UP from ${i} to ${m} - ${JSON.stringify(t)}`)):!o&&a[l]<a[i]&&(T(e),R(`Msg (${f}) relaying DOWN ${i} to ${m} - ${JSON.stringify(t)}`)))}function z(e){return"relay-component-"+e.replace(/[\W]/g,"-").replace(/-+$/,"")}function L(e){const n=e.match(/^(.+){[a-z0-9-]+}$/);return n?n[1]:null}function k(e){let n=e.split("@"),t=n.length>0?parseInt(n[1],10):null;return{level:n[0],tab_id:t,tabId:t}}function A(e){if(null==e&&(e={}),"object"!=typeof e)throw new j("Data payload for message must be an object");let n;try{n=JSON.parse(JSON.stringify(e))}catch(e){throw new j("Data payload for message included non-JSON-serizable data")}return n}function R(e){o&&console.log(`::MSG-RELAY (${l}):: ${e}`)}function x(e,n,t=null){if(n=A(n),t){const n=O(e);e=E(n.type,n.namespace,t)}const i=S(e,l,l,!0,n);i.msgFrom="mock",D(i,{tabId:999})}function W(e,n={},t=null,i=!1){const s=O(e),o=b+(t||"");if(e=E(s.type,s.namespace,o),l===r.iframe||i)return x(e,n);N(e,r.iframe)}function F(){for(let e in c)0===c[e]?c[e]=1:delete c[e]}function J(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}function j(e){this.name="ChromeExtensionMessageRelayError",this.message=e||"Error in chrome extension message relay",this.stack=(new Error).stack}if(m=setInterval(F,12e4),j.prototype=Object.create(Error.prototype),j.prototype.constructor=j,!(l!==r.content&&l!==r.service_worker||chrome&&chrome.runtime&&chrome.runtime.id)){throw new j(`ERROR - invalid context detected for ${l}, aborting.`)}l!==r.test&&([r.page,r.content,r.iframe,r.iframe_shim].includes(l)&&e.addEventListener("message",(e=>{if("object"!=typeof e.data)return;const n=(e=>{if("msg_namespace"in e){let n={};for(let t in e)"msg_namespace"===t?n.relayNamespace=e.msg_namespace:n[t.replace(/_[a-z]/g,(e=>`${e.toUpperCase()}`.replace("_","")))]=e[t];return n}return e})(e.data);"relayNamespace"in n&&n.relayNamespace===f&&D(n,e.source)})),r.content,r.service_worker);const U={levels:r,curLevel:()=>l,on:I,onOnce:(e,n,t=null)=>{I(e,n,t,!0)},off:e=>{w(e)},componentOff:(e,n)=>{w(e,n)},offAll:function(e){if(e)for(let n in p)M(n,e);else p={}},send:C,levelViaTabId:function(e,n){return`${e}@${n}`},levelViaComponentId:function(e){return`${l}@${e}`},getLastMsgSenderInfo:()=>d,getLastMsgType:()=>u.type,getLastMsg:()=>u,mockSend:x,localSend:x,componentSend:W,componentLocalSend:(e,n={},t=null)=>{W(e,n,t,!0)},componentOn:function(e,n,t,i=!1){if(![r.page,r.content,r.iframe_shim].includes(l))throw new j("Cannot bind component on listeners in this level");const s=b+n;I(e,t,[r.iframe,r.iframe_shim],i,s)},componentRespond:function(e,n){const t=u;t.component&&C(e,r.iframe,n,t.component)},clearTMO:function(){clearInterval(m)},registerComponentInitializedCb:(e,n=null)=>{g.push({fn:e,name_filter:n})},setComponentEnvData:e=>{h=e},setOverrideLocalComponentInit:e=>{h=e,_=!0},getComponentEnvData:()=>h};class P{constructor(e,n,t=!1){this.enabled=!0,this._relay=e,this._componentName=n,this._componentId=`${n}{${J()}}`,this._debug=t,this._ready=!1,this._initialized=!1,this._pendingInitCalls=[],this._limitLevels=[this._relay.levels.page,this._relay.levels.content,this._relay.levels.iframe_shim]}get _initMsg(){return`${$.initEnv}._CSTATE`}markReady(e=null){const n=e=>{if(this._ready)return;if(this._log("markReady"),!this.enabled)return;const n=n=>{for(e(n);this._pendingInitCalls.length;){let e=this._pendingInitCalls.shift();e.cb(e.data)}this.off(this._initMsg)};_?n(h):(this.on(this._initMsg,n),this.send(`${$.ready}._CSTATE`)),this._ready=!0};return e?n(e):new Promise((e=>{n(e)}))}markInitialized(){this._initialized||(this._log("MarkInitialized"),this.enabled&&(this._initialized=!0,this.send(`${$.initialized}._CSTATE`)))}_log(...e){if(!this._debug)return;const n=Array.from(arguments);n.unshift(`[${this.enabled?"":"DISABLED "}COMPONENT ${this._componentId}`),console.warn(...n)}onOnce(e,n){this.on(e,n,!0)}on(e,n,t=!1){this._log(">>> .on"+(t?"Once":""),e),this.enabled&&this._relay.on(e,(t=>{if(this._log(">>> .on called",e,t),!this._ready&&e!==this._initMsg)return this._pendingInitCalls.push({cb:n,data:t});n(t)}),this._limitLevels,t,this._componentId)}send(e,n={}){this._log(">>> .send",e,n),this.enabled&&this._relay.send(e,this._limitLevels,n,this._componentId)}off(e){this._log(">>> .off",e),this._relay.componentOff(e,this._componentId)}}return U.newComponent=(e,n=!1)=>{if(l!==r.iframe&&!_)throw new j("You can only create a component in an iframe level.");let t=new P(U,e,n);return v[t.id]=t,t},U};"undefined"!=typeof module&&module.exports?module.exports=n:"chromeExtensionMessageRelay"in e||(e.chromeExtensionMessageRelay=e.chrome_extension_message_relay=n)})(void 0!==this?this:"undefined"==typeof window?{}:window);