"undefined"!=typeof globalThis&&(globalThis.IRX=globalThis),"IRX"in this||(this.IRX={}),"irxGlobals"in this||(this.irxGlobals=this.IRX),(globals=>{const relay=function(namespace,relayLevel,debug,targetDomain){targetDomain||(targetDomain="*");const _debug=debug||!1,LEVELS=Object.freeze({service_worker:"service_worker",content:"content",page:"page",iframe:"iframe",iframe_shim:"iframe_shim",test:"test"}),LEVEL_ORDER=Object.freeze({service_worker:4,content:3,page:2,iframe_shim:1,iframe:0,test:-1}),level=relayLevel;let _receivedMessages={},_receivedMsgCleanTmo=null,_relayNamespace=namespace,_lastSender=null,_lastMsg=null,_listeners={},_onComponentInitializedFns=[],_componentEnvData={},_componentLocalOverride=!1;const COMPONENT_STATE=Object.freeze({ready:"ready",initEnv:"initEnv",initialized:"initalized"}),_components={};function _bind(msgTypes,cb,limitFromLevels=null,isOnce=!1,componentFilter=null){"string"==typeof msgTypes&&(msgTypes=[msgTypes]),limitFromLevels&&!Array.isArray(limitFromLevels)&&(limitFromLevels=[limitFromLevels]),msgTypes.forEach((msgType=>{let mtypeInfo=_getMtypeInfo(msgType);mtypeInfo.type in _listeners||(_listeners[mtypeInfo.type]=[]),_listeners[mtypeInfo.type].push({fn:cb,ns:mtypeInfo.namespace,limitFromLevels,componentFilter,isOnce})}))}function _unbind(msgTypes,componentId=null){msgTypes&&("string"==typeof msgTypes&&(msgTypes=[msgTypes]),msgTypes.forEach((msgType=>{let mtypeInfo=_getMtypeInfo(msgType);mtypeInfo.type in _listeners&&(mtypeInfo.namespace?_unbindNamspaceListenersForMessageType(mtypeInfo.type,mtypeInfo.namespace):delete _listeners[mtypeInfo.type])})))}function _buildMsgTypeFromParts(type,namespace=null,componentId=null){let msgType=type;return namespace&&(msgType+="."+namespace),componentId&&(msgType+=`[${componentId}]`),msgType}function _getMtypeInfo(msgType){let type=null,namespace=null,component=null;const matches=(msgType=msgType.split("@@@")[0]).match(/^([\w:_-]+)\.?([\w:_-]+)?(\[(.+)])?$/);return matches[2]?(namespace=matches[2],type=matches[1]):type=matches[1],matches[4]&&(component=matches[4]),{type,namespace,component}}function _unbindNamspaceListenersForMessageType(msgType,namespace){msgType in _listeners&&(_listeners[msgType]=_listeners[msgType].filter((l=>l.ns!==namespace)),_listeners[msgType].length||delete _listeners[msgType])}function _getMsg(type,dest,sourceLevel,up,data){let msgId="msgId"in(data=_validateData(data))?data.msgId:function(dest,msgType){return`${dest}:${msgType}@@@${_guid()}`}(dest,type);data.msgId=msgId;let msgObj={msgType:type,msgFrom:level,sourceLevel,msgDestination:dest,msgUp:up,relayNamespace:_relayNamespace,msgData:data,msgId,msgTabId:null};const destObj=_parseDestination(dest);return destObj.tabId&&(msgObj.msgDestination=destObj.level,msgObj.msgTabId=destObj.tabId),msgObj}function _sendMsg(msgType,destinations,data,componentId=null){if(data=_validateData(data),"string"==typeof destinations&&(destinations=[destinations]),componentId){const mtypeParts=_getMtypeInfo(msgType);msgType=_buildMsgTypeFromParts(mtypeParts.type,mtypeParts.namespace,componentId)}destinations.forEach((dest=>{if(!function(dest){return!!dest&&_parseDestination(dest).level in LEVELS}(dest))return _log(`NOTICE - invalid level specified as destination (${dest})`);const destLevel=_parseDestination(dest).level;LEVEL_ORDER[destLevel]<LEVEL_ORDER[level]?_sendDown(msgType,dest,data):function(msgType,destination,data){const msg=_getMsg(msgType,destination,level,!0,data);_log(`Send msg UP from ${level} to ${destination} : ${msgType} - ${JSON.stringify(data)}`),_relay(msg)}(msgType,dest,data)}))}function _sendDown(msgType,destination,data={}){const msg=_getMsg(msgType,destination,level,!1,data);_log(`Send msg DOWN from ${level} to ${destination} : ${msgType} - ${JSON.stringify(data)}`),_relay(msg)}function _relay(msgObj){!function(thisLevel,msg){if(thisLevel===LEVELS.content&&msg.msgDestination===LEVELS.service_worker||thisLevel===LEVELS.service_worker);else if(thisLevel===LEVELS.iframe||msg.msgDestination!==LEVELS.iframe&&thisLevel===LEVELS.iframe_shim)globals.parent.postMessage(msg,targetDomain);else if(thisLevel!==LEVELS.page&&thisLevel!==LEVELS.content||![LEVELS.iframe,LEVELS.iframe_shim].includes(msg.msgDestination))if(msg.msgDestination===LEVELS.iframe&&thisLevel===LEVELS.iframe_shim)for(let i=0;i<globals.frames.length;i++)globals.frames[i].postMessage(msg,"*");else globals.postMessage(msg,"*");else{const iframes=document.getElementsByTagName("iframe"),{component}=_getMtypeInfo(msg.msgType);for(let i=0;i<iframes.length;i++){if(component&&!component.startsWith("***")&&iframes[i].getAttribute(_componentIdDataAttr(component))!==COMPONENT_STATE.ready)continue;let target="*";(level!==LEVELS.content||(target="chrome-extension://"+chrome.runtime.id,iframes[i].src.startsWith(target)))&&iframes[i].contentWindow.postMessage(msg,target)}}}(level,msgObj)}function _incomingMessage(msg,sender){const{msgData,msgFrom,sourceLevel,msgUp,msgDestination,msgType,msgId}=msg;sender&&(_lastSender=sender),_lastMsg=_getMtypeInfo(msgType);const msgReceptionId=`${msgId}:${msgDestination}`;if(msgFrom===level||msgReceptionId in _receivedMessages)return!1;msgDestination===level?(_log(`Msg (${msgType}) received from ${msgFrom} to ${msgDestination} - ${JSON.stringify(msgData)}`),_receivedMessages[msgReceptionId]=0,function(msgType,msgData,sourceLevel){delete msgData.msgId,delete msgData.msg_id;const{component,namespace,type}=_getMtypeInfo(msgType);if(component&&[LEVELS.content,LEVELS.page,LEVELS.iframe_shim].includes(level)){const cWindow=_lastSender,iframe=Array.from(document.getElementsByTagName("iframe")).find((ifr=>ifr.contentWindow===cWindow));if("_CSTATE"===namespace){if(type===COMPONENT_STATE.ready){_log(`Component ${component} is ready`);const dataAttr=_componentIdDataAttr(component);iframe.setAttribute(dataAttr,COMPONENT_STATE.ready);let new_msgType=function(type,componentId){return _buildMsgTypeFromParts(type,"_CSTATE",componentId)}(COMPONENT_STATE.initEnv,component);return _sendDown(new_msgType,LEVELS.iframe,_componentEnvData)}if(type===COMPONENT_STATE.initialized){const compName=_componentNameFromId(component);_onComponentInitializedFns.forEach((item=>{item.name_filter&&0!==compName.localeCompare(item.name_filter)||item.fn(compName,iframe,_lastSender)}))}}}if(!(type in _listeners))return;const listeners=_listeners[type];for(let i=listeners.length-1;i>=0;i--){const listener=listeners[i],limitFrom=listener.limitFromLevels;if(!limitFrom||limitFrom.includes(sourceLevel)){if(component&&[LEVELS.page,LEVELS.content,LEVELS.iframe_shim].includes(level)){const listenerCompFilter=listener.componentFilter;if("***"!==listenerCompFilter){const filterCheck=listenerCompFilter||"";if(!filterCheck.startsWith("***")&&component!==listenerCompFilter)return;if(filterCheck.startsWith("***")){if(_componentNameFromId(component)!==listenerCompFilter.replace("***",""))return}}}listener.fn.call(listener,msgData),listener.isOnce&&listeners.splice(i,1)}}}(msgType,msgData,sourceLevel)):(msg.msgFrom=level,msgUp&&LEVEL_ORDER[level]>LEVEL_ORDER[msgFrom]?(_relay(msg),_log(`Msg (${msgType}) relaying UP from ${msgFrom} to ${msgDestination} - ${JSON.stringify(msgData)}`)):!msgUp&&LEVEL_ORDER[level]<LEVEL_ORDER[msgFrom]&&(_relay(msg),_log(`Msg (${msgType}) relaying DOWN ${msgFrom} to ${msgDestination} - ${JSON.stringify(msgData)}`)))}function _componentIdDataAttr(component){return"relay-component-"+component.replace(/[\W]/g,"-").replace(/-+$/,"")}function _componentNameFromId(id){const matches=id.match(/^(.+){[a-z0-9-]+}$/);return matches?matches[1]:null}function _parseDestination(dest){let parts=dest.split("@"),tabId=parts.length>0?parseInt(parts[1],10):null;return{level:parts[0],tab_id:tabId,tabId}}function _validateData(data){if(null==data&&(data={}),"object"!=typeof data)throw new ChromeExtensionMessageRelayError("Data payload for message must be an object");let newData;try{newData=JSON.parse(JSON.stringify(data))}catch(e){throw new ChromeExtensionMessageRelayError("Data payload for message included non-JSON-serizable data")}return newData}function _log(msg){_debug&&console.log(`::MSG-RELAY (${level}):: ${msg}`)}function _localSendMsg(msgType,data,componentId=null){if(data=_validateData(data),componentId){const mtypeParts=_getMtypeInfo(msgType);msgType=_buildMsgTypeFromParts(mtypeParts.type,mtypeParts.namespace,componentId)}const msg=_getMsg(msgType,level,level,!0,data);msg.msgFrom="mock",_incomingMessage(msg,{tabId:999})}function _componentSend(msgType,data={},componentName=null,forceLocal=!1){const mtypeParts=_getMtypeInfo(msgType),componentFilter="***"+(componentName||"");if(msgType=_buildMsgTypeFromParts(mtypeParts.type,mtypeParts.namespace,componentFilter),level===LEVELS.iframe||forceLocal)return _localSendMsg(msgType,data);_sendDown(msgType,LEVELS.iframe)}function _deleteInterval(){for(let msgId in _receivedMessages)0===_receivedMessages[msgId]?_receivedMessages[msgId]=1:delete _receivedMessages[msgId]}function _guid(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}function ChromeExtensionMessageRelayError(message){this.name="ChromeExtensionMessageRelayError",this.message=message||"Error in chrome extension message relay",this.stack=(new Error).stack}if(_receivedMsgCleanTmo=setInterval(_deleteInterval,12e4),ChromeExtensionMessageRelayError.prototype=Object.create(Error.prototype),ChromeExtensionMessageRelayError.prototype.constructor=ChromeExtensionMessageRelayError,!(level!==LEVELS.content&&level!==LEVELS.service_worker||chrome&&chrome.runtime&&chrome.runtime.id)){throw new ChromeExtensionMessageRelayError(`ERROR - invalid context detected for ${level}, aborting.`)}level!==LEVELS.test&&([LEVELS.page,LEVELS.content,LEVELS.iframe,LEVELS.iframe_shim].includes(level)&&globals.addEventListener("message",(event=>{if("object"!=typeof event.data)return;const msg=(msg=>{if("msg_namespace"in msg){let translated={};for(let key in msg)"msg_namespace"===key?translated.relayNamespace=msg.msg_namespace:translated[key.replace(/_[a-z]/g,(letter=>`${letter.toUpperCase()}`.replace("_","")))]=msg[key];return translated}return msg})(event.data);"relayNamespace"in msg&&msg.relayNamespace===_relayNamespace&&_incomingMessage(msg,event.source)})),LEVELS.content,LEVELS.service_worker);const RETURNS={levels:LEVELS,curLevel:()=>level,on:_bind,onOnce:(msgTypes,cb,limitFromLevels=null)=>{_bind(msgTypes,cb,limitFromLevels,!0)},off:msgTypes=>{_unbind(msgTypes)},componentOff:(msgTypes,componentId)=>{_unbind(msgTypes,componentId)},offAll:function(namespace){if(namespace)for(let msgType in _listeners)_unbindNamspaceListenersForMessageType(msgType,namespace);else _listeners={}},send:_sendMsg,levelViaTabId:function(level,tabId){return`${level}@${tabId}`},levelViaComponentId:function(componentId){return`${level}@${componentId}`},getLastMsgSenderInfo:()=>_lastSender,getLastMsgType:()=>_lastMsg.type,getLastMsg:()=>_lastMsg,mockSend:_localSendMsg,localSend:_localSendMsg,componentSend:_componentSend,componentLocalSend:(msgType,data={},componentName=null)=>{_componentSend(msgType,data,componentName,!0)},componentOn:function(msgType,componentName,cb,isOnce=!1){if(![LEVELS.page,LEVELS.content,LEVELS.iframe_shim].includes(level))throw new ChromeExtensionMessageRelayError("Cannot bind component on listeners in this level");const targetComponent="***"+componentName;_bind(msgType,cb,[LEVELS.iframe,LEVELS.iframe_shim],isOnce,targetComponent)},componentRespond:function(msgType,data){const last=_lastMsg;last.component&&_sendMsg(msgType,LEVELS.iframe,data,last.component)},clearTMO:function(){clearInterval(_receivedMsgCleanTmo)},registerComponentInitializedCb:(fn,nameFilter=null)=>{_onComponentInitializedFns.push({fn,name_filter:nameFilter})},setComponentEnvData:envData=>{_componentEnvData=envData},setOverrideLocalComponentInit:envData=>{_componentEnvData=envData,_componentLocalOverride=!0},getComponentEnvData:()=>_componentEnvData};class Component{constructor(relay,componentName,debug=!1){this.enabled=!0,this._relay=relay,this._componentName=componentName,this._componentId=`${componentName}{${_guid()}}`,this._debug=debug,this._ready=!1,this._initialized=!1,this._pendingInitCalls=[],this._limitLevels=[this._relay.levels.page,this._relay.levels.content,this._relay.levels.iframe_shim]}get _initMsg(){return`${COMPONENT_STATE.initEnv}._CSTATE`}markReady(initEnvCallback=null){const _=cb=>{if(this._ready)return;if(this._log("markReady"),!this.enabled)return;const initReturn=envData=>{for(cb(envData);this._pendingInitCalls.length;){let call=this._pendingInitCalls.shift();call.cb(call.data)}this.off(this._initMsg)};_componentLocalOverride?initReturn(_componentEnvData):(this.on(this._initMsg,initReturn),this.send(`${COMPONENT_STATE.ready}._CSTATE`)),this._ready=!0};return initEnvCallback?_(initEnvCallback):new Promise((resolve=>{_(resolve)}))}markInitialized(){this._initialized||(this._log("MarkInitialized"),this.enabled&&(this._initialized=!0,this.send(`${COMPONENT_STATE.initialized}._CSTATE`)))}_log(...args){if(!this._debug)return;const items=Array.from(arguments);items.unshift(`[${this.enabled?"":"DISABLED "}COMPONENT ${this._componentId}`),console.warn(...items)}onOnce(msgType,cb){this.on(msgType,cb,!0)}on(msgType,cb,onOnce=!1){this._log(">>> .on"+(onOnce?"Once":""),msgType),this.enabled&&this._relay.on(msgType,(data=>{if(this._log(">>> .on called",msgType,data),!this._ready&&msgType!==this._initMsg)return this._pendingInitCalls.push({cb,data});cb(data)}),this._limitLevels,onOnce,this._componentId)}send(msgType,data={}){this._log(">>> .send",msgType,data),this.enabled&&this._relay.send(msgType,this._limitLevels,data,this._componentId)}off(msgTypes){this._log(">>> .off",msgTypes),this._relay.componentOff(msgTypes,this._componentId)}}return RETURNS.newComponent=(component_name,debug=!1)=>{if(level!==LEVELS.iframe&&!_componentLocalOverride)throw new ChromeExtensionMessageRelayError("You can only create a component in an iframe level.");let component=new Component(RETURNS,component_name,debug);return _components[component.id]=component,component},RETURNS};"undefined"!=typeof module&&module.exports?module.exports=relay:"chromeExtensionMessageRelay"in globals||(globals.chromeExtensionMessageRelay=globals.chrome_extension_message_relay=relay)})(void 0!==this?this:"undefined"==typeof window?{}:window),(IRX=>{IRX.LoggableClass=IRX.LoggableClass||class LoggableClass{_logging;#_debugColor;constructor(debug,recordLogs=!0){this._logging={debug,classLogName:this.constructor.name,recordLogs}}getEnv(){return new Promise((async resolve=>{resolve(await IRX.storeUtils.get("env")||"production")}))}#debugColor(klass){const possibleColors=["#C0392B","#633974","#1A5276","#0E6655","#196F3D","#9A7D0A","#935116","#34495E","#E74C3C","#A569BD","#3498DB","#1ABC9C","#58D68D","#F39C12","#DC7633"];return this.#_debugColor=this.#_debugColor||possibleColors[Math.floor(Math.random()*possibleColors.length)],this.#_debugColor}#debugConsole(){if(!("LOGGER"in IRX)||!this._logging.debug)return;const level=IRX.LOGGER.level,allArgs=[`%cIRX%c[${this._logging.classLogName}]%c${level}`,"font-weight: bold; color: black; background: #f2f2f2; padding: 4px;",`font-weight: bold; background: #f2f2f2; padding: 4px; color: ${this.#debugColor()};`,"font-weight: bold; color: #5c5c5c; background: #f2f2f2; padding: 4px;"].concat(Array.from(arguments));console.log(...allArgs)}log(...args){this._logging.recordLogs&&"LOGGER"in IRX&&IRX.LOGGER.log(this._logging.classLogName,this._logging.debug,...args),this.#debugConsole(...args)}logNoStore(...args){this._logging.recordLogs&&"LOGGER"in IRX&&IRX.LOGGER.log(this._logging.classLogName,this._logging.debug,args[0]),this.#debugConsole(...args)}}})(IRX),(globals=>{const RELAY=globals.RELAY||globals.chrome_extension_message_relay("IRX","page",!1);globals.IS_DEV=!1,globals.LOGGER=window.LOGGER||(()=>{function _push(process,data,context="core"){!function(logData){Array.isArray(logData)||(logData=[logData]);RELAY.send("write.logs",RELAY.levels.iframe_shim,{logs:logData})}({context,process,data})}return{log:(process,...data)=>{for(let elem of data)elem instanceof Error&&(globals.IS_DEV&&console.error(elem),elem=elem.toString());globals.IS_DEV,_push(process,data)},level:"page"}})(),globals.RELAY=RELAY})(IRX);
//# sourceMappingURL=manifest_page_primary_bundle.js.map
